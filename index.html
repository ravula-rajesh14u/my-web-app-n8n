 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeDrop: Blood Donor Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Lighter background */
        }
        .donor-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .donor-card:hover {
            transform: translateY(-3px);
            /* Custom shadow with a touch of red for emphasis */
            box-shadow: 0 12px 20px -5px rgba(239, 68, 68, 0.2), 0 4px 6px -2px rgba(239, 68, 68, 0.08);
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #f87171;
            border-radius: 4px;
        }
    </style>
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // Global variables provided by the Canvas environment (used for setup)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'lifedrop-default-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- IMPORTANT: FALLBACK CONFIGURATION (User's provided keys) ---
        const FALLBACK_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAbcunNYa1fkdtOQ0IoORwz-dodW2kyhV4",
            authDomain: "blooddonar-app-71fb5.firebaseapp.com",
            projectId: "blooddonar-app-71fb5",
            storageBucket: "blooddonar-app-71fb5.firebasestorage.app",
            messagingSenderId: "652032534017",
            appId: "1:652032534017:web:bb73ce54cd5ea6c8904200",
            measurementId: "G-NEKHBBJQY2"
        };
        
        // Configuration Logic
        let firebaseConfig = FALLBACK_FIREBASE_CONFIG; 
        const envConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

        if (envConfigString && envConfigString.trim() !== '') {
            try {
                const parsedEnvConfig = JSON.parse(envConfigString);
                if (parsedEnvConfig.apiKey && parsedEnvConfig.authDomain) {
                    firebaseConfig = parsedEnvConfig;
                } else {
                    console.warn("Environment config lacked required fields. Sticking to hardcoded fallback.");
                }
            } catch (e) {
                console.error("Error parsing __firebase_config from environment. Sticking to hardcoded fallback.", e);
            }
        }
        window.firebaseConfig = firebaseConfig;
        console.log("Final Firebase Config used:", firebaseConfig);
        // ----------------------------------------------------


        let db, auth;
        let currentUserId = null;
        let isAuthReady = false;
        let currentUserData = null; // Store current user's profile
        
        // Constants for 56-day rule
        const MIN_DAYS_BETWEEN_DONATIONS = 56;
        const MIN_MS_BETWEEN_DONATIONS = MIN_DAYS_BETWEEN_DONATIONS * 24 * 60 * 60 * 1000; // 56 days in milliseconds

        // --- Utility Functions ---

        // Utility function to show custom messages
        const showMessage = (message, type = 'info') => {
            const container = document.getElementById('message-container');
            const color = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
            const html = `<div class="${color} text-white px-4 py-2 rounded-lg shadow-lg mb-4 text-sm">${message}</div>`;
            container.innerHTML = html;
            container.style.display = 'block';
            setTimeout(() => {
                container.innerHTML = '';
                container.style.display = 'none';
            }, 5000);
        };

        // Haversine formula to calculate distance
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        };

        // Utility function to open map for navigation
        const navigateToDonor = (lat, lng) => {
            if (lat && lng) {
                // CORRECTED Google Maps URL for coordinates:
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`; // <-- This is the fix!
                window.open(googleMapsUrl, '_blank');
            } // ...
        };
        window.navigateToDonor = navigateToDonor;

        // Toggle password visibility
        const togglePasswordVisibility = (inputId, iconId) => {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.97 0-9.23-2.99-11.23-7a1.002 1.002 0 011.02-1.42l3.41 3.41m2.812-2.812A2 2 0 0112 13a2 2 0 012-2c.465 0 .895.167 1.237.456l.78-.78m2.59-2.59L22.9 2.1l-1.414 1.414L1.414 21.086l1.414 1.414L10.5 15.586a10.05 10.05 0 005.15-2.02l3.18 3.18a1.002 1.002 0 01-1.42 1.02z"></path></svg>`;
            } else {
                input.type = 'password';
                icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`;
            }
        };
        window.togglePasswordVisibility = togglePasswordVisibility;

        // ====================================================================
        // === n8n WEBHOOK FUNCTIONALITY (IP Tracking) ========================
        // ====================================================================

        // The unique webhook URL you just created in n8n
        // NOTE: This must match the URL you provided: http://localhost:5678/webhook-test/update-location
        const N8N_WEBHOOK_URL = 'http://localhost:5678/webhook/update-location';

        /**
         * Fetches the user's public IP and sends it along with their User ID to n8n for processing.
         * This runs once upon successful login.
         * @param {string} userId - The Firebase UID of the logged-in user.
         */
        const updateLocationViaN8N = async (userId) => {
            console.log("Attempting to send location update to n8n...");
            try {
                // 1. Get the public IP address using an external, public API
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const ipAddress = ipData.ip;

                // 2. Data payload for n8n
                const payload = { 
                    userId: userId,
                    ip: ipAddress 
                };
                
                // 3. Send data to the n8n Webhook
                const n8nResponse = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log(`[INFO] IP Geolocation request sent to n8n. Check n8n Editor for success. IP: ${ipAddress}`);
                

            } catch (error) {
                console.error("[CRITICAL ERROR] Could not connect to n8n or fetch IP (Is n8n running?):", error);
            }
        };

        // ====================================================================
        // === END OF n8n WEBHOOK FUNCTIONALITY ===============================
        // ====================================================================
        
        // --- Forgot Password Function ---
        const handleForgotPassword = async () => {
            const emailInput = document.getElementById('login-email');
            const email = emailInput.value;

            if (!email) {
                showMessage("Please enter your email address to reset your password.", 'error');
                emailInput.focus();
                return;
            }

            try {
                if (!auth) {
                    showMessage("Authentication system is not ready.", 'error');
                    return;
                }
                
                await sendPasswordResetEmail(auth, email);
                showMessage(`Password reset link sent to ${email}. Check your inbox! if yuou cant find it in inbox search for in spam `, 'success');
            } catch (error) {
                console.error("Password reset failed:", error);
                showMessage(`Password reset failed: ${error.message}`, 'error');
            }
        };
        window.handleForgotPassword = handleForgotPassword;


        // Function to update current user's data display
        const updateDonorStatusDisplay = () => {
            const statusDiv = document.getElementById('donor-status-display');
            if (!currentUserData) {
                statusDiv.innerHTML = '<p class="text-gray-500">Loading donor profile...</p>';
                return;
            }

            const lastDonationMs = currentUserData.lastDonationDate || 0;
            const timeSinceDonationMs = Date.now() - lastDonationMs;
            
            const daysRemaining = MIN_DAYS_BETWEEN_DONATIONS - Math.floor(timeSinceDonationMs / (24 * 60 * 60 * 1000));

            let donationStatusHtml;
            if (daysRemaining > 0) {
                donationStatusHtml = `
                    <p class="text-lg font-bold text-red-600">Ineligible to donate</p>
                    <p class="text-sm text-red-500">You must wait ${daysRemaining} more days (56-day rule).</p>
                `;
            } else {
                donationStatusHtml = `
                    <p class="text-lg font-bold text-green-600">Eligible to Donate!</p>
                    <p class="text-sm text-green-500">You have completed the required rest period.</p>
                `;
            }

            const lastDonationDate = lastDonationMs 
                ? new Date(lastDonationMs).toLocaleDateString() 
                : 'Never Recorded';
                
            const totalCount = currentUserData.donationCount || 0;

            statusDiv.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <p class="text-base font-medium text-gray-700">Last Donation:</p>
                        <p class="text-base font-semibold text-gray-900">${lastDonationDate}</p>
                    </div>
                    <div class="flex items-center justify-between border-b pb-3">
                        <p class="text-base font-medium text-gray-700">Total Donations:</p>
                        <p class="text-base font-semibold text-red-700">${totalCount}</p>
                    </div>
                    <div class="pt-3">
                        ${donationStatusHtml}
                    </div>
                </div>
            `;
        };
        
        // --- Location Tracking Management (AUTOMATED SESSION TRACKING) ---
        let locationWatchId = null;
        let userLocation = { lat: null, lng: null };

        // Function to handle the successful location update (AUTOMATIC)
        const handleLocationSuccess = async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userLocation.lat = lat;
            userLocation.lng = lng;

            const locationStatus = document.getElementById('location-status');
            locationStatus.innerHTML = `Location LIVE: Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
            locationStatus.classList.remove('text-red-500', 'text-yellow-600');
            locationStatus.classList.add('text-green-500');
            document.getElementById('search-donors-btn').disabled = false;
            
            // Automatically update Firestore with the new location
            if (currentUserId && db) {
                try {
                    const donorDocRef = doc(db, "artifacts", appId, "public", "data", "donors", currentUserId);
                    await setDoc(donorDocRef, {
                        location: { lat: lat, lng: lng },
                        lastUpdated: Date.now()
                    }, { merge: true });
                    // Re-run search whenever location changes (if a search is active)
                    if (document.getElementById('search-bloodType').value) {
                        searchDonors();
                    }
                } catch (error) {
                    console.error("Failed to update location in Firestore:", error);
                }
            }
        };

        // Function to handle location errors (AUTOMATIC)
        const handleLocationError = (error) => {
            console.error("Geolocation Error:", error);
            userLocation.lat = null;
            userLocation.lng = null;
            const locationStatus = document.getElementById('location-status');
            let message = 'Location access failed or denied. Search results may be inaccurate.';
            if (error.code === 1) {
                message = 'Location permission denied. You must enable it in your browser settings.';
            }
            locationStatus.textContent = message;
            locationStatus.classList.remove('text-green-500', 'text-yellow-600');
            locationStatus.classList.add('text-red-500');
            document.getElementById('search-donors-btn').disabled = false;
        };
        
        // === NEW: MANUAL LOCATION FALLBACK FUNCTION ===
        /**
         * Function to manually request the user's location (fallback for mobile failures).
         * This uses getCurrentPosition instead of watchPosition for a one-time, high-accuracy fix.
         */
        window.getPreciseUserLocation = () => {
            const statusText = document.getElementById('manual-location-status');
            const button = document.getElementById('get-manual-location-btn');

            if (!navigator.geolocation) {
                statusText.textContent = 'Geolocation is not supported by your browser.';
                statusText.classList.add('text-red-500');
                return;
            }

            // UI Feedback
            statusText.textContent = 'Finding precise GPS location...';
            statusText.classList.remove('text-red-500', 'text-green-500', 'text-gray-500');
            statusText.classList.add('text-blue-600');
            button.disabled = true;

            // One-time request for position
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // 1. Update the session/search location variables
                    userLocation.lat = lat; 
                    userLocation.lng = lng;

                    // 2. Update the main status display as well
                    const mainStatus = document.getElementById('location-status');
                    mainStatus.innerHTML = `Location FIX: Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)} (Manual)`;
                    mainStatus.classList.remove('text-red-500', 'text-yellow-600');
                    mainStatus.classList.add('text-green-500');

                    // 3. UI Feedback
                    statusText.textContent = `Manual Location set successfully!`;
                    statusText.classList.add('text-green-500');
                    button.disabled = false;

                    // 4. Update Firestore
                    if (currentUserId && db) {
                        const donorDocRef = doc(db, "artifacts", appId, "public", "data", "donors", currentUserId);
                        setDoc(donorDocRef, {
                            location: { lat: lat, lng: lng },
                            lastUpdated: Date.now()
                        }, { merge: true }).catch(e => console.error("Firestore update failed:", e));
                    }

                    // 5. Re-trigger search if a blood type is selected
                    if (document.getElementById('search-bloodType').value) {
                        searchDonors();
                    }
                },
                (error) => {
                    let errorMessage = "Location denied or timed out. Check browser settings.";
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = "Permission Denied: Enable location in browser settings and try again.";
                    }
                    
                    statusText.textContent = errorMessage;
                    statusText.classList.remove('text-blue-600', 'text-green-500');
                    statusText.classList.add('text-red-500');
                    button.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 seconds timeout
                    maximumAge: 0   // Get a fresh location
                }
            );
        };
        // ======================================================

        // Function to start automated location tracking (called when search-view opens)
        const startLocationTracking = () => {
            if (locationWatchId !== null) return; // Already tracking

            const searchBtn = document.getElementById('search-donors-btn');
            const locationStatus = document.getElementById('location-status');

            searchBtn.disabled = true;
            locationStatus.textContent = 'Attempting to acquire live location...';
            locationStatus.classList.remove('text-green-500', 'text-red-500');
            locationStatus.classList.add('text-yellow-600');

            // Start watching the user's position
            locationWatchId = navigator.geolocation.watchPosition(
                handleLocationSuccess,
                handleLocationError,
                { 
                    enableHighAccuracy: true,
                    timeout: 5000, 
                    maximumAge: 0 
                }
            );
        };

        // Function to stop location tracking (Crucial for performance/battery)
        const stopLocationTracking = () => {
            if (locationWatchId !== null) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
                console.log("Location tracking stopped.");
            }
            // Reset location status when logging out/leaving the search view
            const locationStatus = document.getElementById('location-status');
            if (locationStatus) {
                locationStatus.textContent = 'Location tracking stopped.';
                locationStatus.classList.remove('text-green-500', 'text-red-500', 'text-yellow-600');
                locationStatus.classList.add('text-gray-500');
            }
        };


        // --- View Management ---
        window.showView = (viewId) => {
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.add('hidden');
            });
            
            if (viewId !== 'search-view') {
                // Stop tracking if the user navigates away from the search page
                stopLocationTracking(); 
            }

            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
                if (viewId === 'search-view') {
                    // START tracking automatically when user enters search page
                    startLocationTracking(); 
                }
            } else {
                console.error(`View with ID "${viewId}" not found.`);
            }
        };

        const updateNavigationVisibility = (isLoggedIn) => {
            const navRegisterBtn = document.getElementById('nav-register-btn');
            const navLoginBtn = document.getElementById('nav-login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if (isLoggedIn) {
                navRegisterBtn?.classList.add('hidden');
                navLoginBtn?.classList.add('hidden');
                logoutBtn?.classList.remove('hidden');
            } else {
                navRegisterBtn?.classList.remove('hidden');
                navLoginBtn?.classList.remove('hidden');
                logoutBtn?.classList.add('hidden');
            }
        };

        // --- Firebase Initialization and Auth ---

        const initializeFirebase = async () => {
            
            // Final validation before init: CRITICAL CHECK for both apiKey and authDomain
            if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.authDomain) {
                console.error("Fatal Error: Firebase configuration is missing the API Key or Auth Domain.");
                showMessage("Cannot connect to database. Authentication configuration is incomplete.", 'error');
                showView('login-view');
                updateNavigationVisibility(false);
                return;
            }

            setLogLevel('Debug');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 

                onAuthStateChanged(auth, async (user) => {
                    isAuthReady = true;
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${currentUserId}`;
                        showView('search-view');
                        updateNavigationVisibility(true);
                        setupDonorListener(); 
                        setupCurrentUserListener(); // Listener for user-specific profile
                    } else {
                        currentUserId = null;
                        currentUserData = null;
                        showView('login-view'); // Default view when no user is logged in
                        updateNavigationVisibility(false);
                        stopLocationTracking(); // Ensure tracking is stopped on logout
                    }
                });

                // Manual Authentication Attempt (If a custom token exists)
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    }
                } catch (error) {
                    console.error("Firebase Auth Sign-in Error:", error);
                    // Custom error message for when the initial login fails
                    showMessage("Authentication failed. Please login, or register if you are new.", 'error');
                    
                    // Ensure we are on the login view if sign-in failed
                    if (!auth.currentUser) {
                        showView('login-view'); 
                        updateNavigationVisibility(false);
                    }
                }
                
            } catch (configError) {
                   console.error("Firebase Initialization Failed:", configError);
                   showMessage(`Critical initialization failure: ${configError.message}`, 'error');
                   showView('login-view');
                   updateNavigationVisibility(false);
            }
        };

        // --- Current User Profile Listener ---
        const setupCurrentUserListener = () => {
             if (!db || !currentUserId) return;

             const userDocRef = doc(db, "artifacts", appId, "public", "data", "donors", currentUserId);
             onSnapshot(userDocRef, (docSnap) => {
                 if (docSnap.exists()) {
                     currentUserData = docSnap.data();
                     updateDonorStatusDisplay(); // Update the profile panel
                 }
             }, (error) => {
                 console.error("Error setting up current user listener:", error);
             });
        }
        
        // --- Record Donation Logic ---
        window.recordDonation = async () => {
            if (!currentUserId || !db) {
                showMessage("You must be logged in to record a donation.", 'error');
                return;
            }
            if (!currentUserData) {
                showMessage("Loading profile data, please wait...", 'info');
                return;
            }

            const lastDonationMs = currentUserData.lastDonationDate || 0;
            const timeSinceDonationMs = Date.now() - lastDonationMs;
            
            if (timeSinceDonationMs < MIN_MS_BETWEEN_DONATIONS) {
                const daysRemaining = MIN_DAYS_BETWEEN_DONATIONS - Math.floor(timeSinceDonationMs / (24 * 60 * 60 * 1000));
                showMessage(`Cannot record donation. You must wait ${daysRemaining} more days.`, 'error');
                return;
            }

            try {
                const donorDocRef = doc(db, "artifacts", appId, "public", "data", "donors", currentUserId);
                await setDoc(donorDocRef, {
                    lastDonationDate: Date.now(), // New donation timestamp
                    donationCount: increment(1) // Increment the count
                }, { merge: true });

                showMessage("Donation successfully recorded! You are now ineligible to donate for 56 days.", 'success');
            } catch (error) {
                console.error("Failed to record donation:", error);
                showMessage(`Failed to record donation: ${error.message}`, 'error');
            }
        };


        // --- Registration Logic ---
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = e.target.name.value;
            const email = e.target.email.value;
            const bloodType = e.target.bloodType.value;
            const password = e.target.password.value;

            if (!auth || password.length < 6) {
                showMessage("Authentication not ready or password too short.", 'error');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Set initial placeholder location (to be updated automatically on search-view load)
                const lat = 17.3850 + (Math.random() - 0.5) * 0.1; 
                const lng = 78.4867 + (Math.random() - 0.5) * 0.1;

                const donorDocRef = doc(db, "artifacts", appId, "public", "data", "donors", user.uid);
                await setDoc(donorDocRef, {
                    uid: user.uid,
                    name: name,
                    email: email,
                    bloodType: bloodType,
                    location: { lat: lat, lng: lng },
                    lastUpdated: Date.now(),
                    lastDonationDate: 0, 
                    donationCount: 0      
                });

                showMessage("Registration successful! Please wait for location to be acquired.", 'success');
                e.target.reset();
            } catch (error) {
                showMessage(`Registration failed: ${error.message}`, 'error');
            }
        });

        // --- Login Logic ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            if (!auth) return;
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Send the user's ID and IP to n8n immediately upon successful login.
                await updateLocationViaN8N(user.uid); 
                
                showMessage("Login successful!", 'success');
                e.target.reset();
            } catch (error) {
                console.error("Login failed:", error);
                showMessage(`Login failed: ${error.message}`, 'error');
            }
        });

        // --- Logout Logic ---
        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (!auth) return;
            try {
                await signOut(auth);
                stopLocationTracking(); // Stop tracking immediately
                showMessage("Logged out successfully.", 'info');
            } catch (error) {
                console.error("Logout failed:", error);
                showMessage(`Logout failed: ${error.message}`, 'error');
            }
        });

        // --- Donor Search and Real-Time Listener ---

        let donorData = [];
        

        // Real-time listener for all public donor data
        const setupDonorListener = () => {
            if (!db || !isAuthReady) return;

            const donorsColRef = collection(db, "artifacts", appId, "public", "data", "donors");
            onSnapshot(donorsColRef, (snapshot) => {
                donorData = snapshot.docs.map(doc => doc.data());
                console.log(`Received ${donorData.length} donor records in real-time.`);
                if (document.getElementById('search-bloodType').value) {
                    searchDonors();
                }
            }, (error) => {
                console.error("Error setting up donor listener:", error);
                showMessage("Failed to load donor data. Check Firebase rules and Authentication.", 'error');
            });
        };

        const searchDonors = () => {
            const requestedBloodType = document.getElementById('search-bloodType').value;
            const resultsContainer = document.getElementById('donor-results');
            resultsContainer.innerHTML = '';
            
            if (!userLocation.lat || !userLocation.lng) {
                // **UPDATED MESSAGE HERE to suggest the manual button**
                resultsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500 font-semibold mb-2">Your location is not yet acquired. Please wait until 'Tracking Active' shows a green status.</p>
                        <p class="text-sm text-gray-600">If the status remains yellow, or you're on a mobile device, use the **'Get Precise Location'** button above as a fallback.</p>
                    </div>
                `;
                return;
            }

            if (!requestedBloodType) {
                resultsContainer.innerHTML = `<p class="text-yellow-600 text-center py-8">Please select a blood type to search.</p>`;
                return;
            }

            let filteredDonors = donorData.filter(donor => {
                // 1. Filter by Blood Type and exclude self
                if (donor.bloodType !== requestedBloodType || donor.uid === currentUserId) {
                    return false;
                }

                // 2. Apply 56-day exclusion rule
                const lastDonationMs = donor.lastDonationDate || 0;
                const timeSinceDonationMs = Date.now() - lastDonationMs;

                if (timeSinceDonationMs < MIN_MS_BETWEEN_DONATIONS) {
                    // This donor is ineligible due to the 56-day rule
                    return false;
                }

                return true;
            });

            // Calculate distance and sort
            filteredDonors = filteredDonors.map(donor => {
                if (donor.location && donor.location.lat && donor.location.lng) {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        donor.location.lat, donor.location.lng
                    );
                    return { ...donor, distance: distance };
                }
                return { ...donor, distance: Infinity };
            }).sort((a, b) => a.distance - b.distance);

            if (filteredDonors.length === 0) {
                resultsContainer.innerHTML = `<p class="text-gray-500 text-center py-8">No eligible donors found for blood type <span class="font-bold text-red-600">${requestedBloodType}</span> nearby (or they are within the 56-day exclusion period).</p>`;
                return;
            }

            filteredDonors.forEach(donor => {
                const distanceText = donor.distance === Infinity ? 'Location Unavailable' : `${donor.distance.toFixed(2)} km away`;
                
                const navigateButton = donor.distance !== Infinity ? 
                    `<button onclick="navigateToDonor(${donor.location.lat}, ${donor.location.lng})" class="ml-4 px-3 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md flex items-center shrink-0">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243m-4.243 2.828V12a8 8 0 1116 0v6.657m-4.243 2.828V12a8 8 0 00-16 0v6.657l4.243 4.243a1.998 1.998 0 002.828 0l4.243-4.243"></path></svg>
                        Navigate
                    </button>` : '';


                const donorCard = `
                    <div class="donor-card bg-white p-5 rounded-xl shadow-lg border-t-4 border-red-500 flex justify-between items-center transition-all duration-300">
                        <div>
                            <p class="text-xl font-bold text-red-800">${donor.name}</p>
                            <p class="text-sm text-gray-500">Total Donations: <span class="font-semibold text-red-700">${donor.donationCount || 0}</span></p>
                        </div>
                        <div class="flex items-center">
                            <span class="text-xl font-extrabold text-red-500 mr-4">${distanceText}</span>
                            ${navigateButton}
                        </div>
                    </div>
                `;
                resultsContainer.innerHTML += donorCard;
            });
        };
        window.searchDonors = searchDonors;

        // --- Initialize on Document Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            
            // Connect the manual button listener
            document.getElementById('get-manual-location-btn').addEventListener('click', window.getPreciseUserLocation);
        });

    </script>
</head>
<body class="min-h-screen">

    <div id="message-container" class="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 p-4 hidden"></div>

    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 text-2xl font-extrabold text-red-600">
                        LifeDrop 🩸
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="nav-login-btn" onclick="showView('login-view')" class="text-gray-600 hover:text-red-500 font-medium">Login</button>
                    <button id="nav-register-btn" onclick="showView('register-view')" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors">
                        Register as Donor
                    </button>
                    <button id="logout-btn" class="hidden px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div id="login-view" class="app-view hidden max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">Donor Login</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email address</label>
                    <input id="login-email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <input id="login-password" name="password" type="password" autocomplete="current-password" required class="block w-full pr-10 px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                            <span id="login-password-icon" class="text-gray-500 cursor-pointer" onclick="togglePasswordVisibility('login-password', 'login-password-icon')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <button type="button" onclick="handleForgotPassword()" class="text-sm text-blue-600 hover:text-blue-500">
                        Forgot Password?
                    </button>
                    <button type="button" onclick="showView('register-view')" class="text-sm text-red-600 hover:text-red-500 font-medium">
                        Need an account? Register
                    </button>
                </div>
                <div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        Log In
                    </button>
                </div>
            </form>
        </div>

        <div id="register-view" class="app-view hidden max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">Donor Registration</h2>
            <form id="register-form" class="space-y-6">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input id="register-name" name="name" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700">Email address</label>
                    <input id="register-email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="register-bloodType" class="block text-sm font-medium text-gray-700">Blood Type</label>
                    <select id="register-bloodType" name="bloodType" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                        <option value="">Select Blood Type</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                    </select>
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Password (Min 6 chars)</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <input id="register-password" name="password" type="password" required minlength="6" class="block w-full pr-10 px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                            <span id="register-password-icon" class="text-gray-500 cursor-pointer" onclick="togglePasswordVisibility('register-password', 'register-password-icon')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </span>
                        </div>
                    </div>
                </div>
                <div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                        Register
                    </button>
                </div>
            </form>
            <div class="mt-4 text-center">
                <button type="button" onclick="showView('login-view')" class="text-sm text-red-600 hover:text-red-500 font-medium">
                    Already have an account? Login
                </button>
            </div>
        </div>

        <div id="search-view" class="app-view hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex justify-between items-center">
                        Your Donor Status
                        <i class="fas fa-heartbeat text-red-500"></i>
                    </h3>
                    <div id="donor-status-display" class="mb-4">
                        <p class="text-gray-500">Loading profile data...</p>
                    </div>
                    <button onclick="recordDonation()" class="w-full px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors shadow-md">
                        Record a Donation Now
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex justify-between items-center">
                        Find Donors Near You
                        <i class="fas fa-search text-gray-500"></i>
                    </h3>
                    
                    <div id="search-controls" class="space-y-4">
                        
                        <div class="space-y-2">
                            <label for="search-bloodType" class="block text-sm font-medium text-gray-700">Blood Type Needed</label>
                            <select id="search-bloodType" onchange="searchDonors()" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                                <option value="">Select Blood Type...</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                        
                        <div class="space-y-1">
                            <p class="text-sm font-medium text-gray-700">Your Location Status:</p>
                            <p id="location-status" class="text-xs text-yellow-600 font-semibold italic">Attempting to acquire live location...</p>
                        </div>
                        
                        <div class="pt-2 border-t border-gray-100">
                            <button id="get-manual-location-btn" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                <i class="fas fa-location-arrow mr-2"></i> Get Precise Location (Fallback)
                            </button>
                            <p id="manual-location-status" class="text-xs text-gray-500 mt-1 h-4"></p>
                        </div>
                        <div>
                            <button id="search-donors-btn" onclick="searchDonors()" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-lg font-bold text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors" disabled>
                                Search Donors
                            </button>
                        </div>
                        
                    </div>
                </div>

                <p id="user-id-display" class="text-xs text-gray-400 text-center mt-4"></p>
            </div>

            <div class="lg:col-span-2 space-y-4">
                <h3 class="text-2xl font-bold text-gray-800 border-b pb-2">Search Results</h3>
                <div id="donor-results" class="space-y-4 custom-scrollbar max-h-[80vh] overflow-y-auto">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-tint text-4xl mb-4 text-red-400"></i>
                        <p>Select a blood type and wait for location tracking to start searching for nearby donors.</p>
                    </div>
                </div>
            </div>

        </div>

    </main>

</body>
</html>